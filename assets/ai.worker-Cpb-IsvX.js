async function m(c,t){switch(c){case r.PAWN:const{Pawn:s}=await Promise.resolve().then(function(){return nt});return new s(t);case r.ROOK:const{Rook:i}=await import("./rook-ByP8ixul.js");return new i(t);case r.KNIGHT:const{Knight:e}=await import("./knight-BTyYShrd.js");return new e(t);case r.BISHOP:const{Bishop:o}=await import("./bishop-DqLP4R2e.js");return new o(t);case r.QUEEN:const{Queen:n}=await import("./queen-DPVcc8RH.js");return new n(t);case r.KING:const{King:l}=await Promise.resolve().then(function(){return S});return new l(t);default:throw new Error(`Type de pièce inconnu : ${c}`)}}var u=(c=>(c.WHITE="white",c.BLACK="black",c))(u||{}),r=(c=>(c.PAWN="pawn",c.ROOK="rook",c.KNIGHT="knight",c.BISHOP="bishop",c.QUEEN="queen",c.KING="king",c))(r||{});class C{constructor(t,s){this.color=t,this.type=s}hasMoved=!1;isPathClear(t,s,i,e,o){const n=Math.sign(i-t),l=Math.sign(e-s);let f=t+n,h=s+l;for(;f!==i||h!==e;){if(o.getPiece(f,h)!==null)return!1;f+=n,h+=l}return!0}static isKing(t){return t.type==="king"}canCapture(t,s,i){const e=i.getPiece(t,s);return!e||e.color!==this.color}toData(){return{color:this.color,type:this.type}}static async fromData(t){return await m(t.type,t.color)}}class w extends C{hasMoved=!1;type=r.KING;constructor(t){super(t,r.KING)}isValidMove(t,s,i,e,o){if(i<0||i>=8||e<0||e>=8)return!1;const n=Math.abs(i-t),l=Math.abs(e-s);if(n<=1&&l<=1)return this.canCapture(i,e,o)&&!o.isAdjacentToAnotherKing(i,e,this.color);if(!this.hasMoved&&l===0&&n===2){if(o.isSquareUnderAttack(t,s,this.color))return!1;const f=i>t?1:-1,h=i>t?7:0,a=o.getPiece(h,s);if(a&&a.type===r.ROOK&&!a.hasMoved){for(let g=t+f;g!==i;g+=f)if(o.getPiece(g,s)||o.isSquareUnderAttack(g,s,this.color))return!1;return!o.isSquareUnderAttack(i,s,this.color)&&!o.isAdjacentToAnotherKing(i,e,this.color)}}return!1}static isThreatenedMove(t,s,i,e){const o=Math.abs(i-t),n=Math.abs(e-s);return o<=1&&n<=1}}var S=Object.freeze({__proto__:null,King:w});let E=[],k=[];function G(c,t){switch(c){case r.PAWN:return t===u.WHITE?"♙":"♟";case r.ROOK:return t===u.WHITE?"♖":"♜";case r.KNIGHT:return t===u.WHITE?"♘":"♞";case r.BISHOP:return t===u.WHITE?"♗":"♝";case r.QUEEN:return t===u.WHITE?"♕":"♛";case r.KING:return t===u.WHITE?"♔":"♚";default:return""}}function V(c,t){const s=G(c,t);t===u.WHITE?E.push(s):k.push(s),D()}function D(){const c=document.getElementById("capturedWhite"),t=document.getElementById("capturedBlack");c&&(c.textContent=E.join(" ")),t&&(t.textContent=k.join(" "))}class X{grid;enPassantTarget=null;halfMoveCount=0;currentPlayer=u.WHITE;constructor(){this.grid=Array(8).fill(null).map(()=>Array(8).fill(null))}async init(){this.grid=await this.initializeBoard()}async initializeBoard(){const t=Array(8).fill(null).map(()=>Array(8).fill(null));return t[0]=[await m(r.ROOK,u.WHITE),await m(r.KNIGHT,u.WHITE),await m(r.BISHOP,u.WHITE),await m(r.QUEEN,u.WHITE),await m(r.KING,u.WHITE),await m(r.BISHOP,u.WHITE),await m(r.KNIGHT,u.WHITE),await m(r.ROOK,u.WHITE)],t[1]=await Promise.all(Array(8).fill(null).map(()=>m(r.PAWN,u.WHITE))),t[7]=[await m(r.ROOK,u.BLACK),await m(r.KNIGHT,u.BLACK),await m(r.BISHOP,u.BLACK),await m(r.QUEEN,u.BLACK),await m(r.KING,u.BLACK),await m(r.BISHOP,u.BLACK),await m(r.KNIGHT,u.BLACK),await m(r.ROOK,u.BLACK)],t[6]=await Promise.all(Array(8).fill(null).map(()=>m(r.PAWN,u.BLACK))),t}isWithinBounds(t,s){return t>=0&&t<8&&s>=0&&s<8}getPiece(t,s){return this.grid[s][t]}getValidMoves(t,s){let i=null;if(this.isWithinBounds(t,s)&&(i=this.getPiece(t,s)),!i)return[];const e=[];for(let o=0;o<8;o++)for(let n=0;n<8;n++)i.isValidMove(t,s,n,o,this)&&e.push({x:n,y:o});return e}captureEnPassantIfValid(t,s,i,e){if(this.isEnPassantMove(t,s,i,e)){const o=this.getPiece(t,s);if(!o)return;const n=e+(o.color===u.WHITE?-1:1);this.grid[n][i]&&(this.grid[n][i]=null)}}getKingInCheck(){return this.isKingInCheck(u.WHITE)?this.findKing(u.WHITE):this.isKingInCheck(u.BLACK)?this.findKing(u.BLACK):null}movePiece(t,s,i,e){if(!this.isWithinBounds(t,s)||!this.isWithinBounds(i,e)||["__proto__","constructor","prototype"].includes(s.toString())||["__proto__","constructor","prototype"].includes(e.toString()))return!1;const o=this.getPiece(t,s);if(o&&o.isValidMove(t,s,i,e,this)){const n=this.getPiece(i,e);if(n&&n.type===r.KING)return!1;if(o.type===r.KING&&Math.abs(i-t)===2)return this.isCastlingValid(o,t,s,i)?(this.handleCastling(i,s),o.hasMoved=!0,!0):!1;if(o?.type===r.PAWN&&this.isEnPassantMove(t,s,i,e)&&this.captureEnPassant(t,s,i,e),this.grid[e][i]=o,this.grid[s][t]=null,this.isKingInCheck(o.color))return this.grid[s][t]=o,this.grid[e][i]=n,!1;(o.type===r.KING||o.type===r.ROOK)&&(o.hasMoved=!0),this.updateEnPassantTarget(t,s,i,e,o),this.halfMoveCount=o.type===r.PAWN||n?0:this.halfMoveCount+1;const l=o.color===u.WHITE?u.BLACK:u.WHITE;return this.isCheckmate(l),!0}return!1}isCastlingValid(t,s,i,e){const o=e>s?1:-1,n=e>s?7:0,l=this.getPiece(n,i);if(l?.type!==r.ROOK||l.hasMoved||t.hasMoved)return!1;for(let f=s+o;f!==e+o;f+=o)if(this.getPiece(f,i)||this.isSquareUnderAttack(f,i,t.color))return!1;return!0}handleCastling(t,s){if(t===6){const i=this.getPiece(7,s),e=this.getPiece(4,s);i?.type===r.ROOK&&!i.hasMoved&&e?.type===r.KING&&!e.hasMoved&&(this.setPiece(5,s,i),this.setPiece(7,s,null),this.setPiece(6,s,e),this.setPiece(4,s,null),e.hasMoved=!0,i.hasMoved=!0)}else if(t===2){const i=this.getPiece(0,s),e=this.getPiece(4,s);i?.type===r.ROOK&&!i.hasMoved&&e?.type===r.KING&&!e.hasMoved&&(this.setPiece(3,s,i),this.setPiece(0,s,null),this.setPiece(2,s,e),this.setPiece(4,s,null),e.hasMoved=!0,i.hasMoved=!0)}}updateEnPassantTarget(t,s,i,e,o){o?.type===r.PAWN&&Math.abs(e-s)===2&&t===i?this.enPassantTarget={x:i,y:(s+e)/2}:this.enPassantTarget=null}captureEnPassant(t,s,i,e){const o=this.getPiece(t,s);if(this.isEnPassantMove(t,s,i,e)&&o?.type===r.PAWN){const n=o.color===u.WHITE?-1:1,l=e+n,f=this.getPiece(i,l);if(f&&f.type===r.PAWN){this.grid[l][i]=null;const h={capturedWhite:[],capturedBlack:[]};return f.color===u.WHITE?h.capturedWhite.push(f.type):h.capturedBlack.push(f.type),V(f.type,f.color),h}}return null}isEnPassantMove(t,s,i,e){return this.enPassantTarget?this.getPiece(t,s)?.type===r.PAWN&&i===this.enPassantTarget.x&&e===this.enPassantTarget.y&&Math.abs(t-i)===1&&Math.abs(s-e)===1:!1}async promotePawn(t,s,i){const e=this.getPiece(t,s)?.color;if(e)switch(i){case"queen":this.grid[s][t]=await m(r.QUEEN,e);break;case"rook":this.grid[s][t]=await m(r.ROOK,e);break;case"bishop":this.grid[s][t]=await m(r.BISHOP,e);break;case"knight":this.grid[s][t]=await m(r.KNIGHT,e);break}}isKingInCheck(t){const s=this.findKing(t);if(!s)return!1;for(let i=0;i<8;i++)for(let e=0;e<8;e++){const o=this.getPiece(e,i);if(o&&o.color!==t&&o.isValidMove(e,i,s.x,s.y,this))return!0}return!1}isCheckmate(t){if(!this.isKingInCheck(t))return!1;for(let i=0;i<8;i++)for(let e=0;e<8;e++){const o=this.getPiece(e,i);if(o&&o.color===t){const n=this.getValidMoves(e,i);for(const l of n){const f=this.getPiece(l.x,l.y);this.grid[l.y][l.x]=o,this.grid[i][e]=null;const h=!this.isKingInCheck(t);if(this.grid[i][e]=o,this.grid[l.y][l.x]=f,h)return!1}}}return!0}isStalemate(t){if(this.isKingInCheck(t))return!1;for(let s=0;s<8;s++)for(let i=0;i<8;i++){const e=this.getPiece(i,s);if(e&&e.color===t){for(let o=0;o<8;o++)for(let n=0;n<8;n++)if(e.isValidMove(i,s,n,o,this)){const l=this.getPiece(n,o);this.grid[o][n]=e,this.grid[s][i]=null;const f=!this.isKingInCheck(t);if(this.grid[s][i]=e,this.grid[o][n]=l,f)return!1}}}return!0}findKing(t){for(let s=0;s<8;s++)for(let i=0;i<8;i++){const e=this.getPiece(i,s);if(e&&e?.type===r.KING&&e.color===t)return{x:i,y:s}}return null}isKing(t,s){return this.getPiece(t,s)?.type===r.KING}isSquareUnderAttack(t,s,i){for(let e=0;e<8;e++)for(let o=0;o<8;o++){const n=this.getPiece(o,e);if(n&&n.color!==i){if(n.type===r.KING){if(w.isThreatenedMove(o,e,t,s))return!0}else if(n.isValidMove(o,e,t,s,this))return!0}}return!1}isInsufficientMaterial(){const t=this.grid.flat().filter(s=>s!==null);return t.length<=2?!0:t.length===3&&t.some(s=>s?.type===r.BISHOP||s?.type===r.KNIGHT)}isFiftyMoveRule(){return this.halfMoveCount>=50}setPiece(t,s,i){this.grid[s][t]=i}isMoveValid(t,s,i,e){const o=this.getPiece(t,s);if(!o||i<0||i>=8||e<0||e>=8||!o.isValidMove(t,s,i,e,this))return!1;const n=this.getPiece(i,e);return!(n&&n.color===o.color)}isCapture(t,s,i,e){const o=this.isWithinBounds(t,s)?this.getPiece(t,s):null,n=this.isWithinBounds(i,e)?this.getPiece(i,e):null;return o!==null&&n!==null&&o.color!==n.color}static async fromData(t){const s=new X;return await s.init(),s.grid=await Promise.all(t.grid.map(async i=>Promise.all(i.map(async e=>e?await C.fromData(e):null)))),s}toData(){return{grid:this.grid.map(t=>t.map(s=>s?s.toData():null))}}isAdjacentToAnotherKing(t,s,i){const e=[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}];for(const{dx:o,dy:n}of e){const l=t+o,f=s+n,h=this.isWithinBounds(l,f)?this.getPiece(l,f):null;if(h?.type===r.KING&&h.color!==i)return!0}return!1}clone(){const t=new X;return t.grid=this.grid.map(s=>s.map(i=>i?Object.create(Object.getPrototypeOf(i),Object.getOwnPropertyDescriptors(i)):null)),t.enPassantTarget=this.enPassantTarget?{...this.enPassantTarget}:null,t.halfMoveCount=this.halfMoveCount,t}getPieceCount(){return this.grid.flat().filter(t=>t!==null).length}isGameOver(){return this.isCheckmate(u.WHITE)||this.isCheckmate(u.BLACK)||this.isStalemate(u.WHITE)||this.isStalemate(u.BLACK)||this.isInsufficientMaterial()?!0:this.isFiftyMoveRule()}getWinner(){return this.isCheckmate(u.BLACK)?u.WHITE:this.isCheckmate(u.WHITE)?u.BLACK:(this.isStalemate(u.WHITE)||this.isStalemate(u.BLACK)||this.isInsufficientMaterial()||this.isFiftyMoveRule(),null)}getPieces(){return this.grid.flat().filter(t=>t!==null)}setPlayerColor(t){this.currentPlayer=t}getPlayerColor(){return this.currentPlayer}}const T={[r.PAWN]:1,[r.KNIGHT]:3,[r.BISHOP]:3.25,[r.ROOK]:5,[r.QUEEN]:9,[r.KING]:0},$={[r.PAWN]:[[0,0,0,0,0,0,0,0],[.5,.5,.5,.5,.5,.5,.5,.5],[.1,.1,.2,.3,.3,.2,.1,.1],[.05,.05,.1,.25,.25,.1,.05,.05],[0,0,0,.2,.2,0,0,0],[.05,-.05,-.1,0,0,-.1,-.05,.05],[.05,.1,.1,-.2,-.2,.1,.1,.05],[0,0,0,0,0,0,0,0]],[r.KNIGHT]:[[-.5,-.4,-.3,-.3,-.3,-.3,-.4,-.5],[-.4,-.2,0,0,0,0,-.2,-.4],[-.3,0,.1,.15,.15,.1,0,-.3],[-.3,.05,.15,.2,.2,.15,.05,-.3],[-.3,0,.15,.2,.2,.15,0,-.3],[-.3,.05,.1,.15,.15,.1,.05,-.3],[-.4,-.2,0,.05,.05,0,-.2,-.4],[-.5,-.4,-.3,-.3,-.3,-.3,-.4,-.5]],[r.BISHOP]:[[-.2,-.1,-.1,-.1,-.1,-.1,-.1,-.2],[-.1,0,0,0,0,0,0,-.1],[-.1,0,.05,.1,.1,.05,0,-.1],[-.1,.05,.05,.1,.1,.05,.05,-.1],[-.1,0,.1,.1,.1,.1,0,-.1],[-.1,.1,.1,.1,.1,.1,.1,-.1],[-.1,.05,0,0,0,0,.05,-.1],[-.2,-.1,-.1,-.1,-.1,-.1,-.1,-.2]],[r.ROOK]:[[0,0,0,0,0,0,0,0],[.05,.1,.1,.1,.1,.1,.1,.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[0,0,0,.05,.05,0,0,0]],[r.QUEEN]:[[-.2,-.1,-.1,-.05,-.05,-.1,-.1,-.2],[-.1,0,0,0,0,0,0,-.1],[-.1,0,.05,.05,.05,.05,0,-.1],[-.05,0,.05,.05,.05,.05,0,-.05],[0,0,.05,.05,.05,.05,0,-.05],[-.1,.05,.05,.05,.05,.05,0,-.1],[-.1,0,.05,0,0,0,0,-.1],[-.2,-.1,-.1,-.05,-.05,-.1,-.1,-.2]],[r.KING]:[[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.2,-.3,-.3,-.4,-.4,-.3,-.3,-.2],[-.1,-.2,-.2,-.2,-.2,-.2,-.2,-.1],[.2,.2,0,0,0,0,.2,.2],[.2,.3,0,0,0,0,.3,.2]]},Y={"3,3":.5,"3,4":.5,"4,3":.5,"4,4":.5,"2,3":.25,"2,4":.25,"3,2":.25,"4,2":.25,"4,5":.25,"3,5":.25,"5,3":.25,"5,4":.25};function R(c,t){const s=c.findKing(t);return s&&c.isSquareUnderAttack(s.x,s.y,t)?-.5:0}function L(c,t,s,i,e,o){const n=$[c];return n?c===r.PAWN&&W(e,t,s,o)>0?0:i?n[7-s][7-t]:n[s][t]:0}function K(c,t,s=!1){let i=0;for(let e=0;e<8;e++)for(let o=0;o<8;o++){const n=c.getPiece(o,e),l=`${o},${e}`;if(!n)continue;let f=T[n.type];f+=L(n.type,o,e,s,c,n.color),n.type===r.PAWN&&W(c,o,e,n.color)===0&&Y[l]&&(f+=Y[l]),n.type===r.PAWN&&(f+=j(c,o,e,n.color),f+=_(c,o,e,n.color)),n.type===r.KING&&U(c,o,e,n.color)&&(f-=.5),i+=n.color===t?f:-f}return parseFloat(i.toFixed(2))}function _(c,t,s,i){const e=i===u.WHITE?-1:1;let o=0;const n=c.getPiece(t-1,s+e),l=c.getPiece(t+1,s+e);return(n&&n.color===i&&n.type===r.PAWN||l&&l.color===i&&l.type===r.PAWN)&&(o+=.5),o}function j(c,t,s,i){let e=0;const o=Q(c,t,s,i),n=q(c,t,s,i)*.25,l=W(c,t,s,i)*4;return o&&(e+=4.5),e-=n+l,e}function q(c,t,s,i){for(let e=0;e<8;e++)if(e!==s&&c.getPiece(t,e)?.type===r.PAWN&&c.getPiece(t,e)?.color===i)return .5;return 0}function W(c,t,s,i){const e=t-1>=0?c.getPiece(t-1,s):null,o=t+1<8?c.getPiece(t+1,s):null;return e&&e.type===r.PAWN&&e.color===i||o&&o.type===r.PAWN&&o.color===i?0:1.5}function U(c,t,s,i){const e=c.getPiece(t,s);return e&&e.type===r.KING?[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:1,dy:1},{dx:-1,dy:1},{dx:1,dy:-1}].some(({dx:n,dy:l})=>{const f=t+n,h=s+l;if(!c.isWithinBounds(f,h))return!1;const a=c.getPiece(f,h);return!a||a.color!==i||a.type!==r.PAWN}):!1}function Q(c,t,s,i){const e=i===u.WHITE?1:-1;for(let n=s+e;n>=0&&n<8;n+=e){const l=c.getPiece(t,n);if(l&&l.type===r.PAWN&&l.color!==i)return!1}const o=[t-1,t+1];for(const n of o)if(n>=0&&n<8)for(let l=s+e;l>=0&&l<8;l+=e){const f=c.getPiece(n,l);if(f&&f.type===r.PAWN&&f.color!==i)return!1}return!0}function F(c,t){return t?{fromX:7-c.fromX,fromY:7-c.fromY,toX:7-c.toX,toY:7-c.toY}:c}function z(c,t,s=!1){const i=c.getPieces();let e=null;return i.length===3&&p(i,r.KING,t)&&p(i,r.ROOK,t)&&p(i,r.KING,I(t))?e=J(c,t):i.length===4&&p(i,r.KING,t)&&p(i,r.BISHOP,t)&&p(i,r.KNIGHT,t)&&p(i,r.KING,I(t))?e=Z(c,t):i.length===4&&p(i,r.KING,t)&&p(i,r.BISHOP,t)&&i.filter(o=>o.type===r.BISHOP&&o.color===t).length===2&&p(i,r.KING,I(t))?e=b(c,t):i.length===3&&p(i,r.KING,t)&&p(i,r.PAWN,t)&&p(i,r.KING,I(t))&&(e=tt(c,t)),e?F(e,t===u.BLACK||s):null}function p(c,t,s){return c.some(i=>i.type===t&&i.color===s)}function I(c){return c===u.WHITE?u.BLACK:u.WHITE}function J(c,t){const s=M(c,r.KING,I(t)),i=M(c,r.ROOK,t);return!s||!i?null:s.x<4?{fromX:i.x,fromY:i.y,toX:s.x+1,toY:s.y}:{fromX:i.x,fromY:i.y,toX:s.x-1,toY:s.y}}function Z(c,t){const s=M(c,r.KING,I(t)),i=M(c,r.KNIGHT,t),e=M(c,r.BISHOP,t);return!s||!i||!e?null:s.x<4?{fromX:i.x,fromY:i.y,toX:s.x+1,toY:s.y}:{fromX:e.x,fromY:e.y,toX:s.x-1,toY:s.y}}function b(c,t){const s=M(c,r.KING,I(t)),i=et(c,r.BISHOP,t);return!s||i.length<2?null:{fromX:i[0].x,fromY:i[0].y,toX:s.x,toY:s.y>4?s.y-1:s.y+1}}function tt(c,t){const s=M(c,r.KING,I(t)),i=M(c,r.PAWN,t);if(!s||!i)return null;const e=t===u.WHITE?1:-1;return{fromX:i.x,fromY:i.y,toX:i.x,toY:i.y+e}}function M(c,t,s){for(let i=0;i<8;i++)for(let e=0;e<8;e++){const o=c.getPiece(e,i);if(o&&o.type===t&&o.color===s)return{x:e,y:i}}return null}function et(c,t,s){const i=[];for(let e=0;e<8;e++)for(let o=0;o<8;o++){const n=c.getPiece(o,e);n&&n.type===t&&n.color===s&&i.push({x:o,y:e})}return i}const it={"e2e4 e7e5 g1f3 b8c6 f1b5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:1,fromY:0,toX:2,toY:2},{fromX:5,fromY:7,toX:1,toY:5}],"e2e4 c7c5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:3}],"e2e4 c7c5 g1f3 d7d6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:3,fromY:1,toX:3,toY:2}],"d2d4 d7d5 c2c4":[{fromX:3,fromY:6,toX:3,toY:4},{fromX:3,fromY:1,toX:3,toY:3},{fromX:2,fromY:6,toX:2,toY:4}],"e2e4 c7c6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:2}],"e2e4 c7c6 d2d4 d7d5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:2},{fromX:3,fromY:6,toX:3,toY:4},{fromX:3,fromY:1,toX:3,toY:3}],"e2e4 e7e6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:2}],"e2e4 e7e6 d2d4 d7d5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:2},{fromX:3,fromY:6,toX:3,toY:4},{fromX:3,fromY:1,toX:3,toY:3}],"e2e4 e7e5 g1f3 b8c6 f1c4":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:1,fromY:0,toX:2,toY:2},{fromX:5,fromY:7,toX:2,toY:4}],"e2e4 g8f6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:6,fromY:0,toX:5,toY:2}],"e2e4 d7d6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:3,fromY:1,toX:3,toY:2}],"e2e4 e7e5 g1f3 b8c6 d2d4":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:1,fromY:0,toX:2,toY:2},{fromX:3,fromY:6,toX:3,toY:4}],"e2e4 e7e5 f2f4":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:5,fromY:6,toX:5,toY:4}],c2c4:[{fromX:2,fromY:6,toX:2,toY:4}],"g1f3 d7d5":[{fromX:6,fromY:7,toX:5,toY:5},{fromX:3,fromY:1,toX:3,toY:3}]};function H(c,t){return t?{fromX:7-c.fromX,fromY:7-c.fromY,toX:7-c.toX,toY:7-c.toY}:c}function st(c,t){return t[c]?.[0]??null}class ot{constructor(t,s=5e3){this.color=t,this.transpositionTable=new Map,this.maxTime=s,this.killerMoves=new Map,this.startTime=0}openingMoves=it;transpositionTable;maxTime;startTime;killerMoves;moveHistory=[];historicalMoveScores=new Map;makeMove(t){const s=this.getOpeningMove(t);if(s)return this.moveHistory.push(s),s;const i=this.chooseMove(t);if(i)return this.moveHistory.push(i),i;const e=this.useEndgameTablebase(t);if(e)return this.moveHistory.push(e),e;if(this.shouldUseMCTS(t)){const f=this.mcts(t);return f&&this.moveHistory.push(f),f}let o=null,n=-1/0;const l=10;this.startTime=Date.now();for(let f=1;f<=l;f++){let h=this.getAllValidMoves(t);h=this.sortMoves(h,t,f);for(const a of h){const g=t.getPiece(a.fromX,a.fromY);if(!g)continue;const P=t.getPiece(a.toX,a.toY);t.movePiece(a.fromX,a.fromY,a.toX,a.toY);const d=t.isKingInCheck(this.color)||this.isCriticalMove(g,a,t)?f+1:f,v=this.minimax(t,d-1,-1/0,1/0,!1);if(t.setPiece(a.fromX,a.fromY,g),t.setPiece(a.toX,a.toY,P),v>n&&(n=v,o=a),Date.now()-this.startTime>this.maxTime)break}if(Date.now()-this.startTime>this.maxTime)break}return o&&(this.moveHistory.push(o),this.updateHistoricalScore(o)),o}updateHistoricalScore(t){const s=`${t.fromX},${t.fromY},${t.toX},${t.toY}`,i=this.historicalMoveScores.get(s)||0;this.historicalMoveScores.set(s,i+1)}minimax(t,s,i,e,o){const n=t.toString();if(Date.now()-this.startTime>this.maxTime)return this.evaluatePositionWithKingSafety(t,this.color);if(this.transpositionTable.has(n))return this.transpositionTable.get(n);if(s>1&&!t.isKingInCheck(this.color)&&-this.minimax(t,s-2,-e,-i,!o)>=e)return e;if(s===0||t.isCheckmate(this.color)||t.isCheckmate(this.getOpponentColor())||Date.now()-this.startTime>this.maxTime){const l=this.quiescenceSearch(t,i,e);return this.transpositionTable.set(n,l),l}if(o){let l=-1/0,f=this.getAllValidMoves(t);f=this.sortMoves(f,t,s);for(const h of f){const a=t.getPiece(h.fromX,h.fromY),g=t.getPiece(h.toX,h.toY);t.movePiece(h.fromX,h.fromY,h.toX,h.toY);const P=this.minimax(t,s-1,i,e,!1);if(t.setPiece(h.fromX,h.fromY,a),t.setPiece(h.toX,h.toY,g),l=Math.max(l,P),i=Math.max(i,P),e<=i){this.addKillerMove(s,h);break}}return this.transpositionTable.set(n,l),l}else{let l=1/0,f=this.getAllValidMoves(t);f=this.sortMoves(f,t,s);for(let h=0;h<f.length;h++){const a=f[h],g=t.getPiece(a.fromX,a.fromY),P=t.getPiece(a.toX,a.toY),d=h>3&&s>2?s-1:s,v=t.isKingInCheck(this.getOpponentColor()),O=g&&g.type===r.PAWN&&(a.toY===0||a.toY===7),x=v||O?d+1:d;t.movePiece(a.fromX,a.fromY,a.toX,a.toY);const A=this.minimax(t,x-1,i,e,!0);if(t.setPiece(a.fromX,a.fromY,g),t.setPiece(a.toX,a.toY,P),l=Math.min(l,A),e=Math.min(e,A),e<=i){this.addKillerMove(s,a);break}}return this.transpositionTable.set(n,l),l}}chooseMove(t){const s=this.moveHistory.map(e=>`${e.fromX}${e.fromY}${e.toX}${e.toY}`).join(" "),i=st(s,this.openingMoves);if(i){const e=H(i,this.color===u.BLACK);t.movePiece(e.fromX,e.fromY,e.toX,e.toY);const o=K(t,this.color);if(t.setPiece(e.fromX,e.fromY,t.getPiece(e.toX,e.toY)),t.setPiece(e.toX,e.toY,null),o>=.3)return e}return null}addKillerMove(t,s){const i=this.killerMoves.get(t)??[],e=i.find(o=>o.move.fromX===s.fromX&&o.move.fromY===s.fromY);e?e.score+=1:i.push({move:s,score:1}),this.killerMoves.set(t,i.sort((o,n)=>n.score-o.score).slice(0,2))}quiescenceSearch(t,s,i,e=0){const o=this.getAdaptiveQuiescenceDepth(t);if(e>=o)return K(t,this.color);const n=K(t,this.color);if(n>=i)return i;s<n&&(s=n);const l=this.getAllValidMoves(t).filter(a=>t.isCapture(a.fromX,a.fromY,a.toX,a.toY)),f=this.getAllValidMoves(t).filter(a=>{const g=t.getPiece(a.fromX,a.fromY);return!t.isCapture(a.fromX,a.fromY,a.toX,a.toY)&&g&&(g.type===r.PAWN||g.type===r.KNIGHT)}),h=[...l,...f];for(const a of h){const g=t.getPiece(a.fromX,a.fromY),P=t.getPiece(a.toX,a.toY);t.movePiece(a.fromX,a.fromY,a.toX,a.toY);const y=!t.isKingInCheck(this.color);let d=n;if(y&&(d=-this.quiescenceSearch(t,-i,-s,e+1)),t.setPiece(a.fromX,a.fromY,g),t.setPiece(a.toX,a.toY,P),d>=i)return i;d>s&&(s=d)}return s}getOpponentColor(){return this.color===u.WHITE?u.BLACK:u.WHITE}getAllValidMoves(t){const s=[];for(let i=0;i<8;i++)for(let e=0;e<8;e++){const o=t.getPiece(e,i);if(o&&o.color===this.color){const n=t.getValidMoves(e,i);for(const l of n)if(t.isMoveValid(e,i,l.x,l.y)){const f=t.getPiece(l.x,l.y);t.setPiece(l.x,l.y,o),t.setPiece(e,i,null);const h=!t.isKingInCheck(this.color);t.setPiece(e,i,o),t.setPiece(l.x,l.y,f),h&&s.push({fromX:e,fromY:i,toX:l.x,toY:l.y})}}}return s}sortMoves(t,s,i){return t.sort((e,o)=>{const n=s.getPiece(e.toX,e.toY),l=s.getPiece(o.toX,o.toY),f=n?T[n.type]:0,h=l?T[l.type]:0;if(f!==h)return h-f;const a=Y[`${e.toX},${e.toY}`]||0,g=Y[`${o.toX},${o.toY}`]||0;if(a!==g)return g-a;const P=this.killerMoves.get(i);if(P&&P.some(v=>v.move.fromX===e.fromX&&v.move.fromY===e.fromY&&v.move.toX===e.toX&&v.move.toY===e.toY))return-1;const y=this.historicalMoveScores.get(`${e.fromX},${e.fromY},${e.toX},${e.toY}`)||0;return(this.historicalMoveScores.get(`${o.fromX},${o.fromY},${o.toX},${o.toY}`)||0)-y})}mcts(t){const i=new Map,e=this.getAllValidMoves(t).filter(a=>a.fromX!==void 0&&a.fromY!==void 0&&a.toX!==void 0&&a.toY!==void 0);if(e.length===0)return null;for(let a=0;a<1e3;a++){const g=e[Math.floor(Math.random()*e.length)];if(!g||g.fromX===void 0||g.fromY===void 0||g.toX===void 0||g.toY===void 0)continue;const P=this.simulateRandomGame(t,g),y=`${g.fromX},${g.fromY},${g.toX},${g.toY}`;if(i.set(y,(i.get(y)??0)+P),Date.now()-this.startTime>this.maxTime)break}const o=Array.from(i.entries()).reduce((a,g)=>g[1]>a[1]?g:a)[0],[n,l,f,h]=o.split(",").map(Number);return{fromX:n,fromY:l,toX:f,toY:h}}getAdaptiveQuiescenceDepth(t){const s=t.getPieceCount();return s<=6?7:s<=12?5:3}evaluatePositionWithKingSafety(t,s){let i=K(t,s);const e=R(t,s);return i+=e,i}simulateRandomGame(t,s){if(!s||s.fromX===void 0||s.fromY===void 0||s.toX===void 0||s.toY===void 0)return console.error("Invalid move:",s),0;const i=t.clone();i.movePiece(s.fromX,s.fromY,s.toX,s.toY);let e=this.color,o=this.getAllValidMoves(i);for(;!i.isGameOver()&&o.length>0;){const n=o[Math.floor(Math.random()*o.length)];if(!n||n.fromX===void 0||n.fromY===void 0||n.toX===void 0||n.toY===void 0){console.error("Invalid random move:",n);break}i.movePiece(n.fromX,n.fromY,n.toX,n.toY),e=e===u.WHITE?u.BLACK:u.WHITE,o=this.getAllValidMoves(i)}return i.getWinner()===this.color?1:i.getWinner()===null?.5:0}shouldUseMCTS(t){return t.getPieceCount()<=10}useEndgameTablebase(t){return t.getPieceCount()<=4?z(t,this.color):null}isCriticalMove(t,s,i){const e=i.getPiece(s.toX,s.toY);return e&&e.color!==t.color&&e.type!==r.PAWN}getOpeningMove(t){const s=this.getBoardHash(t);if(this.openingMoves[s]){const i=this.openingMoves[s][0],e=H(i,this.color===u.BLACK);t.movePiece(e.fromX,e.fromY,e.toX,e.toY);const o=K(t,this.color);if(t.setPiece(e.fromX,e.fromY,t.getPiece(e.toX,e.toY)),t.setPiece(e.toX,e.toY,null),o>-.5)return e}return null}getBoardHash(t){let s="";for(let i=0;i<8;i++)for(let e=0;e<8;e++){const o=t.getPiece(e,i);if(o){const n=o.color===u.WHITE?o.type:o.type.toLowerCase();s+=n+e+i+" "}}return s.trim()}}class B extends C{hasMoved=!1;_toX=null;_toY=null;_board=null;constructor(t){super(t,r.PAWN)}isValidMove(t,s,i,e,o){if(i<0||i>=8||e<0||e>=8)return!1;const n=o.getPlayerColor(),l=this.color===u.WHITE?1:-1,f=this.color===u.WHITE?1:6,h=(e-s)*l,a=Math.abs(i-t),g=n===u.WHITE?7:0;if(a===0&&h===1&&!o.getPiece(i,e))return e===g?this.handlePromotion(i,e,o):!0;if(a===1&&h===1){if(o.getPiece(i,e)&&this.canCapture(i,e,o))return e===g?this.handlePromotion(i,e,o):!0;if(o.isEnPassantMove(t,s,i,e))return o.captureEnPassantIfValid(t,s,i,e),!0}return a===0&&h===2&&s===f&&!o.getPiece(i,e)&&!o.getPiece(t,s+l)?(o.updateEnPassantTarget(t,s,i,e,this),this.hasMoved=!0,!0):!1}handlePromotion(t,s,i){return this._toX=t,this._toY=s,this._board=i,!0}}var nt=Object.freeze({__proto__:null,Pawn:B});let N;self.onmessage=async c=>{const{boardData:t,aiColor:s}=c.data;N=new ot(s);const i=await X.fromData(t),e=N.makeMove(i);let o=null;if(e&&i.isCapture(e.fromX,e.fromY,e.toX,e.toY)){const l=i.getPiece(e.toX,e.toY);l&&(o={capturedWhite:[],capturedBlack:[]},l.color===u.WHITE?o.capturedWhite.push(l.type):o.capturedBlack.push(l.type))}let n=!1;if(e&&i.getPiece(e.fromX,e.fromY)?.type===r.PAWN){const l=i.getPiece(e.fromX,e.fromY);if(l instanceof B){const f=s===u.WHITE?7:0;e.toY===f&&(n=l.handlePromotion(e.toX,e.toY,i))}}self.postMessage({bestMove:e,captureData:o,promotionRequired:n})};export{C as P,r as a,m as c};
//# sourceMappingURL=ai.worker-Cpb-IsvX.js.map
