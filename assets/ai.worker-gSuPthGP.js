var f=(a=>(a.WHITE="white",a.BLACK="black",a))(f||{}),r=(a=>(a.PAWN="pawn",a.ROOK="rook",a.KNIGHT="knight",a.BISHOP="bishop",a.QUEEN="queen",a.KING="king",a))(r||{});async function g(a,t){switch(a){case r.PAWN:const{Pawn:e}=await import("./pawn-BE9rd82b.js");return new e(t);case r.ROOK:const{Rook:i}=await import("./rook-CuYX8CyN.js");return new i(t);case r.KNIGHT:const{Knight:o}=await import("./knight-BZOhs6XW.js");return new o(t);case r.BISHOP:const{Bishop:n}=await import("./bishop-CYJOmCq2.js");return new n(t);case r.QUEEN:const{Queen:s}=await import("./queen-CwtBkVtQ.js");return new s(t);case r.KING:const{King:l}=await import("./king-DQBet3t-.js");return new l(t);default:throw new Error(`Unknown piece type: ${a}`)}}class w{constructor(t,e){this.color=t,this.type=e}hasMoved=!1;isPathClear(t,e,i,o,n){const s=Math.sign(i-t),l=Math.sign(o-e);let c=t+s,h=e+l;for(;c!==i||h!==o;){if(n.getPiece(c,h)!==null)return!1;c+=s,h+=l}return!0}static isKing(t){return t.type===r.KING}canCapture(t,e,i){const o=i.getPiece(t,e);return!o||o.color!==this.color}toData(){return{color:this.color,type:this.type}}static async fromData(t){return await g(t.type,t.color)}}let E=[],A=[];function B(a,t){switch(a){case r.PAWN:return t===f.WHITE?"♙":"♟";case r.ROOK:return t===f.WHITE?"♖":"♜";case r.KNIGHT:return t===f.WHITE?"♘":"♞";case r.BISHOP:return t===f.WHITE?"♗":"♝";case r.QUEEN:return t===f.WHITE?"♕":"♛";case r.KING:return t===f.WHITE?"♔":"♚";default:return""}}function N(a,t){const e=B(a,t);t===f.WHITE?E.push(e):A.push(e),H()}function H(){const a=document.getElementById("capturedWhite"),t=document.getElementById("capturedBlack");a&&(a.textContent=E.join(" ")),t&&(t.textContent=A.join(" "))}class y{grid=Array(8).fill(null).map(()=>Array(8).fill(null));enPassantTarget=null;halfMoveCount=0;constructor(){this.populateBoard()}async populateBoard(){this.grid=await this.initializeBoard()}async initializeBoard(){const t=Array(8).fill(null).map(()=>Array(8).fill(null));return t[0]=[await g(r.ROOK,f.WHITE),await g(r.KNIGHT,f.WHITE),await g(r.BISHOP,f.WHITE),await g(r.QUEEN,f.WHITE),await g(r.KING,f.WHITE),await g(r.BISHOP,f.WHITE),await g(r.KNIGHT,f.WHITE),await g(r.ROOK,f.WHITE)],t[1]=await Promise.all(Array(8).fill(null).map(()=>g(r.PAWN,f.WHITE))),t[7]=[await g(r.ROOK,f.BLACK),await g(r.KNIGHT,f.BLACK),await g(r.BISHOP,f.BLACK),await g(r.QUEEN,f.BLACK),await g(r.KING,f.BLACK),await g(r.BISHOP,f.BLACK),await g(r.KNIGHT,f.BLACK),await g(r.ROOK,f.BLACK)],t[6]=await Promise.all(Array(8).fill(null).map(()=>g(r.PAWN,f.BLACK))),t}isWithinBounds(t,e){return t>=0&&t<8&&e>=0&&e<8}getPiece(t,e){return this.grid[e][t]}getValidMoves(t,e){let i=null;if(this.isWithinBounds(t,e)&&(i=this.getPiece(t,e)),!i)return[];const o=[];for(let n=0;n<8;n++)for(let s=0;s<8;s++)i.isValidMove(t,e,s,n,this)&&o.push({x:s,y:n});return o}getKingInCheck(){return this.isKingInCheck(f.WHITE)?this.findKing(f.WHITE):this.isKingInCheck(f.BLACK)?this.findKing(f.BLACK):null}movePiece(t,e,i,o){if(!this.isWithinBounds(t,e)||!this.isWithinBounds(i,o)||["__proto__","constructor","prototype"].includes(e.toString())||["__proto__","constructor","prototype"].includes(o.toString()))return!1;const n=this.getPiece(t,e);if(n&&n.isValidMove(t,e,i,o,this)){const s=this.getPiece(i,o);if(s&&s.type===r.KING)return!1;if(w.isKing(n)&&Math.abs(i-t)===2)return this.isCastlingValid(n,t,e,i)?(this.handleCastling(i,e),!0):!1;if(n?.type===r.PAWN&&this.isEnPassantMove(t,e,i,o)&&this.captureEnPassant(t,e,i,o),this.grid[o][i]=n,this.grid[e][t]=null,this.isKingInCheck(n.color))return this.grid[e][t]=n,this.grid[o][i]=s,!1;"hasMoved"in n&&(n.hasMoved=!0),this.updateEnPassantTarget(t,e,i,o,n),this.halfMoveCount=n.type===r.PAWN||s?0:this.halfMoveCount+1;const l=n.color===f.WHITE?f.BLACK:f.WHITE;return this.isCheckmate(l),!0}return!1}isCastlingValid(t,e,i,o){const n=o>e?1:-1,s=o>e?7:0,l=this.getPiece(s,i);if(l?.type!==r.ROOK||l.hasMoved||t.hasMoved)return!1;for(let c=e+n;c!==o;c+=n)if(this.getPiece(c,i)||this.isSquareUnderAttack(c,i,t.color))return!1;return!this.isSquareUnderAttack(e,i,t.color)&&!this.isSquareUnderAttack(o,i,t.color)}handleCastling(t,e){t===6?this.getPiece(7,e)?.type===r.ROOK&&this.movePiece(7,e,5,e):t===2&&this.getPiece(0,e)?.type===r.ROOK&&this.movePiece(0,e,3,e)}updateEnPassantTarget(t,e,i,o,n){n?.type===r.PAWN&&Math.abs(o-e)===2&&t===i?this.enPassantTarget={x:i,y:(e+o)/2}:this.enPassantTarget=null}captureEnPassant(t,e,i,o){const n=this.getPiece(t,e);if(this.isEnPassantMove(t,e,i,o)&&n?.type===r.PAWN){const s=n.color===f.WHITE?-1:1,l=o+s,c=this.getPiece(i,l);if(c&&c.type===r.PAWN){this.grid[l][i]=null;const h={capturedWhite:[],capturedBlack:[]};return c.color===f.WHITE?h.capturedWhite.push(c.type):h.capturedBlack.push(c.type),N(c.type,c.color),h}}return null}isEnPassantMove(t,e,i,o){return this.enPassantTarget?this.getPiece(t,e)?.type===r.PAWN&&i===this.enPassantTarget.x&&o===this.enPassantTarget.y&&Math.abs(t-i)===1&&Math.abs(e-o)===1:!1}async promotePawn(t,e,i){const o=this.getPiece(t,e)?.color;if(o)switch(i){case"queen":this.grid[e][t]=await g(r.QUEEN,o);break;case"rook":this.grid[e][t]=await g(r.ROOK,o);break;case"bishop":this.grid[e][t]=await g(r.BISHOP,o);break;case"knight":this.grid[e][t]=await g(r.KNIGHT,o);break}}isKingInCheck(t){const e=this.findKing(t);if(!e)return!1;for(let i=0;i<8;i++)for(let o=0;o<8;o++){const n=this.getPiece(o,i);if(n&&n.color!==t&&n.isValidMove(o,i,e.x,e.y,this))return!0}return!1}isCheckmate(t){if(!this.isKingInCheck(t))return!1;for(let e=0;e<8;e++)for(let i=0;i<8;i++){const o=this.getPiece(i,e);if(o&&o.color===t){const n=this.getValidMoves(i,e);for(const s of n){const l=this.getPiece(s.x,s.y);this.grid[s.y][s.x]=o,this.grid[e][i]=null;const c=!this.isKingInCheck(t);if(this.grid[e][i]=o,this.grid[s.y][s.x]=l,c)return!1}}}return!0}isStalemate(t){if(this.isKingInCheck(t))return!1;for(let e=0;e<8;e++)for(let i=0;i<8;i++){const o=this.getPiece(i,e);if(o&&o.color===t){for(let n=0;n<8;n++)for(let s=0;s<8;s++)if(o.isValidMove(i,e,s,n,this)){const l=this.getPiece(s,n);this.grid[n][s]=o,this.grid[e][i]=null;const c=!this.isKingInCheck(t);if(this.grid[e][i]=o,this.grid[n][s]=l,c)return!1}}}return!0}findKing(t){for(let e=0;e<8;e++)for(let i=0;i<8;i++){const o=this.getPiece(i,e);if(o&&o?.type===r.KING&&o.color===t)return{x:i,y:e}}return null}isKing(t,e){return this.getPiece(t,e)?.type===r.KING}isSquareUnderAttack(t,e,i){for(let o=0;o<8;o++)for(let n=0;n<8;n++){const s=this.getPiece(n,o);if(s&&s.color!==i&&s.isValidMove(n,o,t,e,this))return!0}return!1}isInsufficientMaterial(){const t=this.grid.flat().filter(e=>e!==null);return t.length<=2?!0:t.length===3&&t.some(e=>e?.type===r.BISHOP||e?.type===r.KNIGHT)}isFiftyMoveRule(){return this.halfMoveCount>=50}setPiece(t,e,i){this.grid[e][t]=i}isMoveValid(t,e,i,o){const n=this.getPiece(t,e);if(!n||i<0||i>=8||o<0||o>=8||!n.isValidMove(t,e,i,o,this))return!1;const s=this.getPiece(i,o);return!(s&&s.color===n.color)}isCapture(t,e,i,o){const n=this.isWithinBounds(t,e)?this.getPiece(t,e):null,s=this.isWithinBounds(i,o)?this.getPiece(i,o):null;return n!==null&&s!==null&&n.color!==s.color}static async fromData(t){const e=new y;return await e.initializeBoard(),e.grid=await Promise.all(t.grid.map(async i=>Promise.all(i.map(async o=>o?await w.fromData(o):null)))),e}toData(){return{grid:this.grid.map(t=>t.map(e=>e?e.toData():null))}}isAdjacentToAnotherKing(t,e,i){const o=[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}];for(const{dx:n,dy:s}of o){const l=t+n,c=e+s,h=this.isWithinBounds(l,c)?this.getPiece(l,c):null;if(h?.type===r.KING&&h.color!==i)return!0}return!1}clone(){const t=new y;return t.grid=this.grid.map(e=>e.map(i=>i?Object.create(Object.getPrototypeOf(i),Object.getOwnPropertyDescriptors(i)):null)),t.enPassantTarget=this.enPassantTarget?{...this.enPassantTarget}:null,t.halfMoveCount=this.halfMoveCount,t}getPieceCount(){return this.grid.flat().filter(t=>t!==null).length}isGameOver(){return this.isCheckmate(f.WHITE)||this.isCheckmate(f.BLACK)||this.isStalemate(f.WHITE)||this.isStalemate(f.BLACK)||this.isInsufficientMaterial()?!0:this.isFiftyMoveRule()}getWinner(){return this.isCheckmate(f.BLACK)?f.WHITE:this.isCheckmate(f.WHITE)?f.BLACK:(this.isStalemate(f.WHITE)||this.isStalemate(f.BLACK)||this.isInsufficientMaterial()||this.isFiftyMoveRule(),null)}getPieces(){return this.grid.flat().filter(t=>t!==null)}}const k={[r.PAWN]:1,[r.KNIGHT]:3,[r.BISHOP]:3.25,[r.ROOK]:5,[r.QUEEN]:9,[r.KING]:0},x={[r.PAWN]:[[0,0,0,0,0,0,0,0],[.5,.5,.5,.5,.5,.5,.5,.5],[.1,.1,.2,.3,.3,.2,.1,.1],[.05,.05,.1,.25,.25,.1,.05,.05],[0,0,0,.2,.2,0,0,0],[.05,-.05,-.1,0,0,-.1,-.05,.05],[.05,.1,.1,-.2,-.2,.1,.1,.05],[0,0,0,0,0,0,0,0]],[r.KNIGHT]:[[-.5,-.4,-.3,-.3,-.3,-.3,-.4,-.5],[-.4,-.2,0,0,0,0,-.2,-.4],[-.3,0,.1,.15,.15,.1,0,-.3],[-.3,.05,.15,.2,.2,.15,.05,-.3],[-.3,0,.15,.2,.2,.15,0,-.3],[-.3,.05,.1,.15,.15,.1,.05,-.3],[-.4,-.2,0,.05,.05,0,-.2,-.4],[-.5,-.4,-.3,-.3,-.3,-.3,-.4,-.5]],[r.BISHOP]:[[-.2,-.1,-.1,-.1,-.1,-.1,-.1,-.2],[-.1,0,0,0,0,0,0,-.1],[-.1,0,.05,.1,.1,.05,0,-.1],[-.1,.05,.05,.1,.1,.05,.05,-.1],[-.1,0,.1,.1,.1,.1,0,-.1],[-.1,.1,.1,.1,.1,.1,.1,-.1],[-.1,.05,0,0,0,0,.05,-.1],[-.2,-.1,-.1,-.1,-.1,-.1,-.1,-.2]],[r.ROOK]:[[0,0,0,0,0,0,0,0],[.05,.1,.1,.1,.1,.1,.1,.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[0,0,0,.05,.05,0,0,0]],[r.QUEEN]:[[-.2,-.1,-.1,-.05,-.05,-.1,-.1,-.2],[-.1,0,0,0,0,0,0,-.1],[-.1,0,.05,.05,.05,.05,0,-.1],[-.05,0,.05,.05,.05,.05,0,-.05],[0,0,.05,.05,.05,.05,0,-.05],[-.1,.05,.05,.05,.05,.05,0,-.1],[-.1,0,.05,0,0,0,0,-.1],[-.2,-.1,-.1,-.05,-.05,-.1,-.1,-.2]],[r.KING]:[[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.2,-.3,-.3,-.4,-.4,-.3,-.3,-.2],[-.1,-.2,-.2,-.2,-.2,-.2,-.2,-.1],[.2,.2,0,0,0,0,.2,.2],[.2,.3,0,0,0,0,.3,.2]]},v={"3,3":.5,"3,4":.5,"4,3":.5,"4,4":.5,"2,3":.25,"2,4":.25,"3,2":.25,"4,2":.25,"4,5":.25,"3,5":.25,"5,3":.25,"5,4":.25};function W(a,t){let e=0;for(let i=0;i<8;i++)for(let o=0;o<8;o++){const n=a.getPiece(o,i);if(n){let s=k[n.type];const l=x[n.type];l&&(s+=l[i][o]);const c=`${o},${i}`;v[c]&&(s+=v[c]),n.type===r.PAWN&&(s+=O(a,o,i,n.color),D(a,o,i,n.color)&&(s+=1)),n.type===r.KING&&V(a,o,i,n.color)&&(s-=.5),e+=n.color===t?s:-s}}return e}function O(a,t,e,i){let o=0;return o-=S(a,t,e,i)*1.5,o-=G(a,t,e,i)*1.5,o}function S(a,t,e,i){for(let o=0;o<8;o++)if(o!==e&&a.getPiece(t,o)?.type===r.PAWN&&a.getPiece(t,o)?.color===i)return .5;return 0}function G(a,t,e,i){const o=t-1>=0?a.getPiece(t-1,e):null,n=t+1<8?a.getPiece(t+1,e):null;return(!o||o.type!==r.PAWN||o.color!==i)&&(!n||n.type!==r.PAWN||n.color!==i)?1.5:0}function V(a,t,e,i){const o=a.getPiece(t,e);return o&&o.type===r.KING?[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:1,dy:1},{dx:-1,dy:1},{dx:1,dy:-1}].some(({dx:s,dy:l})=>{const c=t+s,h=e+l;if(a.isWithinBounds(c,h)){const u=a.getPiece(c,h);return!u||u.color!==i||u.type!==r.PAWN}return!0}):!1}function D(a,t,e,i){const o=i===f.WHITE?-1:1;for(let s=e+o;s>=0&&s<8;s+=o){const l=a.getPiece(t,s);if(l&&l.type===r.PAWN&&l.color!==i)return!1}return[t-1,t+1].every(s=>{if(s<0||s>=8)return!0;for(let l=0;l<8;l++){const c=a.getPiece(s,l);if(c&&c.type===r.PAWN&&c.color===i)return!1}return!0})}function L(a,t){const e=a.getPieces();return e.length===3&&P(e,r.KING,t)&&P(e,r.ROOK,t)&&P(e,r.KING,Y(t))?R(a,t):e.length===4&&P(e,r.KING,t)&&P(e,r.BISHOP,t)&&P(e,r.KNIGHT,t)&&P(e,r.KING,Y(t))?U(a,t):e.length===4&&P(e,r.KING,t)&&P(e,r.BISHOP,t)&&e.filter(i=>i.type===r.BISHOP&&i.color===t).length===2&&P(e,r.KING,Y(t))?q(a,t):e.length===3&&P(e,r.KING,t)&&P(e,r.PAWN,t)&&P(e,r.KING,Y(t))?j(a,t):null}function P(a,t,e){return a.some(i=>i.type===t&&i.color===e)}function Y(a){return a===f.WHITE?f.BLACK:f.WHITE}function R(a,t){const e=X(a,r.KING,Y(t)),i=X(a,r.ROOK,t);return!e||!i?null:e.x<4?{fromX:i.x,fromY:i.y,toX:e.x+1,toY:e.y}:{fromX:i.x,fromY:i.y,toX:e.x-1,toY:e.y}}function U(a,t){const e=X(a,r.KING,Y(t)),i=X(a,r.KNIGHT,t),o=X(a,r.BISHOP,t);return!e||!i||!o?null:e.x<4?{fromX:i.x,fromY:i.y,toX:e.x+1,toY:e.y}:{fromX:o.x,fromY:o.y,toX:e.x-1,toY:e.y}}function q(a,t){const e=X(a,r.KING,Y(t)),i=Q(a,r.BISHOP,t);return!e||i.length<2?null:{fromX:i[0].x,fromY:i[0].y,toX:e.x,toY:e.y>4?e.y-1:e.y+1}}function j(a,t){const e=X(a,r.KING,Y(t)),i=X(a,r.PAWN,t);if(!e||!i)return null;const o=t===f.WHITE?1:-1;return{fromX:i.x,fromY:i.y,toX:i.x,toY:i.y+o}}function X(a,t,e){for(let i=0;i<8;i++)for(let o=0;o<8;o++){const n=a.getPiece(o,i);if(n&&n.type===t&&n.color===e)return{x:o,y:i}}return null}function Q(a,t,e){const i=[];for(let o=0;o<8;o++)for(let n=0;n<8;n++){const s=a.getPiece(n,o);s&&s.type===t&&s.color===e&&i.push({x:n,y:o})}return i}const $={"e2e4 e7e5 g1f3 b8c6 f1b5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:1,fromY:0,toX:2,toY:2},{fromX:5,fromY:7,toX:1,toY:5}],"e2e4 c7c5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:3}],"e2e4 c7c5 g1f3 d7d6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:3,fromY:1,toX:3,toY:2}],"d2d4 d7d5 c2c4":[{fromX:3,fromY:6,toX:3,toY:4},{fromX:3,fromY:1,toX:3,toY:3},{fromX:2,fromY:6,toX:2,toY:4}],"e2e4 c7c6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:2}],"e2e4 c7c6 d2d4 d7d5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:2,fromY:1,toX:2,toY:2},{fromX:3,fromY:6,toX:3,toY:4},{fromX:3,fromY:1,toX:3,toY:3}],"e2e4 e7e6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:2}],"e2e4 e7e6 d2d4 d7d5":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:2},{fromX:3,fromY:6,toX:3,toY:4},{fromX:3,fromY:1,toX:3,toY:3}],"e2e4 e7e5 g1f3 b8c6 f1c4":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:1,fromY:0,toX:2,toY:2},{fromX:5,fromY:7,toX:2,toY:4}],"e2e4 g8f6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:6,fromY:0,toX:5,toY:2}],"e2e4 d7d6":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:3,fromY:1,toX:3,toY:2}],"e2e4 e7e5 g1f3 b8c6 d2d4":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:6,fromY:7,toX:5,toY:5},{fromX:1,fromY:0,toX:2,toY:2},{fromX:3,fromY:6,toX:3,toY:4}],"e2e4 e7e5 f2f4":[{fromX:4,fromY:6,toX:4,toY:4},{fromX:4,fromY:1,toX:4,toY:3},{fromX:5,fromY:6,toX:5,toY:4}],c2c4:[{fromX:2,fromY:6,toX:2,toY:4}],"g1f3 d7d5":[{fromX:6,fromY:7,toX:5,toY:5},{fromX:3,fromY:1,toX:3,toY:3}]};class _{constructor(t,e=5e3){this.color=t,this.transpositionTable=new Map,this.maxTime=e,this.killerMoves=new Map,this.startTime=0}openingMoves=$;transpositionTable;maxTime;startTime;killerMoves;makeMove(t){const e=this.getOpeningMove(t);if(e)return e;const i=this.useEndgameTablebase(t);if(i)return i;if(this.shouldUseMCTS(t))return this.mcts(t);let o=null,n=-1/0;const s=10;this.startTime=Date.now();for(let l=1;l<=s;l++){let c=this.getAllValidMoves(t);c=this.sortMoves(c,t,l);for(const h of c){const u=t.getPiece(h.fromX,h.fromY);if(!u)continue;const m=t.getPiece(h.toX,h.toY);t.movePiece(h.fromX,h.fromY,h.toX,h.toY);const I=t.isKingInCheck(this.color)||this.isCriticalMove(u,h,t)?l+1:l,d=this.minimax(t,I-1,-1/0,1/0,!1);if(t.setPiece(h.fromX,h.fromY,u),t.setPiece(h.toX,h.toY,m),d>n&&(n=d,o=h),Date.now()-this.startTime>this.maxTime)break}if(Date.now()-this.startTime>this.maxTime)break}return o}minimax(t,e,i,o,n){const s=t.toString();if(Date.now()-this.startTime>this.maxTime)return W(t,this.color);if(this.transpositionTable.has(s))return this.transpositionTable.get(s);if(e>1&&!t.isKingInCheck(this.color)&&-this.minimax(t,e-2,-o,-i,!n)>=o)return o;if(e===0||t.isCheckmate(this.color)||t.isCheckmate(this.getOpponentColor())||Date.now()-this.startTime>this.maxTime){const l=this.quiescenceSearch(t,i,o);return this.transpositionTable.set(s,l),l}if(n){let l=-1/0,c=this.getAllValidMoves(t);c=this.sortMoves(c,t,e);for(let h=0;h<c.length;h++){const u=c[h],m=t.getPiece(u.fromX,u.fromY),p=t.getPiece(u.toX,u.toY),d=h>3&&e>2?e-1:e,M=t.isKingInCheck(this.color),C=m&&m.type===r.PAWN&&(u.toY===0||u.toY===7),T=M||C?d+1:d;t.movePiece(u.fromX,u.fromY,u.toX,u.toY);const K=this.minimax(t,T-1,i,o,!1);if(t.setPiece(u.fromX,u.fromY,m),t.setPiece(u.toX,u.toY,p),l=Math.max(l,K),i=Math.max(i,K),o<=i){this.addKillerMove(e,u);break}}return this.transpositionTable.set(s,l),l}else{let l=1/0,c=this.getAllValidMoves(t);c=this.sortMoves(c,t,e);for(let h=0;h<c.length;h++){const u=c[h],m=t.getPiece(u.fromX,u.fromY),p=t.getPiece(u.toX,u.toY),d=h>3&&e>2?e-1:e,M=t.isKingInCheck(this.getOpponentColor()),C=m&&m.type===r.PAWN&&(u.toY===0||u.toY===7),T=M||C?d+1:d;t.movePiece(u.fromX,u.fromY,u.toX,u.toY);const K=this.minimax(t,T-1,i,o,!0);if(t.setPiece(u.fromX,u.fromY,m),t.setPiece(u.toX,u.toY,p),l=Math.min(l,K),o=Math.min(o,K),o<=i){this.addKillerMove(e,u);break}}return this.transpositionTable.set(s,l),l}}addKillerMove(t,e){const i=this.killerMoves.get(t)||[],o=i.find(n=>n.move.fromX===e.fromX&&n.move.fromY===e.fromY&&n.move.toX===e.toX&&n.move.toY===e.toY);o?o.score+=1:i.push({move:e,score:1}),i.sort((n,s)=>s.score-n.score),this.killerMoves.set(t,i)}quiescenceSearch(t,e,i,o=0){if(o>=10)return W(t,this.color);const s=W(t,this.color);if(s>=i)return i;e<s&&(e=s);const l=this.getAllValidMoves(t).filter(c=>t.isCapture(c.fromX,c.fromY,c.toX,c.toY));for(const c of l){const h=t.getPiece(c.fromX,c.fromY),u=t.getPiece(c.toX,c.toY);if(t.movePiece(c.fromX,c.fromY,c.toX,c.toY),!t.isKingInCheck(this.color)){const p=-this.quiescenceSearch(t,-i,-e,o+1);if(t.setPiece(c.fromX,c.fromY,h),t.setPiece(c.toX,c.toY,u),p>=i)return i;p>e&&(e=p)}else t.setPiece(c.fromX,c.fromY,h),t.setPiece(c.toX,c.toY,u)}return e}getOpponentColor(){return this.color===f.WHITE?f.BLACK:f.WHITE}getAllValidMoves(t){const e=[];for(let i=0;i<8;i++)for(let o=0;o<8;o++){const n=t.getPiece(o,i);if(n&&n.color===this.color){const s=t.getValidMoves(o,i);for(const l of s)if(t.isMoveValid(o,i,l.x,l.y)){const c=t.getPiece(l.x,l.y);t.setPiece(l.x,l.y,n),t.setPiece(o,i,null);const h=!t.isKingInCheck(this.color);t.setPiece(o,i,n),t.setPiece(l.x,l.y,c),h&&e.push({fromX:o,fromY:i,toX:l.x,toY:l.y})}}}return e}sortMoves(t,e,i){return t.sort((o,n)=>{const s=this.killerMoves.get(i);if(s&&s.some(m=>m.move.fromX===o.fromX&&m.move.fromY===o.fromY))return-1;const l=e.getPiece(o.toX,o.toY),c=e.getPiece(n.toX,n.toY);if(l&&!c)return-1;if(!l&&c)return 1;const h=v[`${o.toX},${o.toY}`]||0;return(v[`${n.toX},${n.toY}`]||0)-h})}mcts(t){const i=new Map,o=this.getAllValidMoves(t);for(let u=0;u<1e3;u++){const m=o[Math.floor(Math.random()*o.length)];if(!m||m.fromX===void 0||m.fromY===void 0||m.toX===void 0||m.toY===void 0)continue;const p=this.simulateRandomGame(t,m),I=`${m.fromX},${m.fromY},${m.toX},${m.toY}`;i.set(I,(i.get(I)||0)+p)}if(i.size===0)return null;const n=Array.from(i.entries()).reduce((u,m)=>m[1]>u[1]?m:u)[0],[s,l,c,h]=n.split(",").map(Number);return{fromX:s,fromY:l,toX:c,toY:h}}simulateRandomGame(t,e){if(!e||e.fromX===void 0||e.fromY===void 0||e.toX===void 0||e.toY===void 0)return console.error("Invalid move:",e),0;const i=t.clone();i.movePiece(e.fromX,e.fromY,e.toX,e.toY);let o=this.color,n=this.getAllValidMoves(i);for(;!i.isGameOver()&&n.length>0;){const s=n[Math.floor(Math.random()*n.length)];if(!s||s.fromX===void 0||s.fromY===void 0||s.toX===void 0||s.toY===void 0){console.error("Invalid random move:",s);break}i.movePiece(s.fromX,s.fromY,s.toX,s.toY),o=o===f.WHITE?f.BLACK:f.WHITE,n=this.getAllValidMoves(i)}return i.getWinner()===this.color?1:i.getWinner()===null?.5:0}shouldUseMCTS(t){return t.getPieceCount()<=10}useEndgameTablebase(t){return t.getPieceCount()<=4?L(t,this.color):null}isCriticalMove(t,e,i){const o=i.getPiece(e.toX,e.toY);return o&&o.color!==t.color||i.isKingInCheck(t.color)}getOpeningMove(t){const e=this.getBoardHash(t);return this.openingMoves[e]?this.openingMoves[e][0]:null}getBoardHash(t){let e="";for(let i=0;i<8;i++)for(let o=0;o<8;o++){const n=t.getPiece(o,i);if(n){const s=n.color===f.WHITE?n.type:n.type.toLowerCase();e+=s+o+i+" "}}return e.trim()}}const F=new _(f.BLACK);self.onmessage=async a=>{const{boardData:t}=a.data,e=await y.fromData(t),i=F.makeMove(e);let o=null;if(i&&e.isCapture(i.fromX,i.fromY,i.toX,i.toY)){const n=e.getPiece(i.toX,i.toY);n&&(o={capturedWhite:[],capturedBlack:[]},n.color===f.WHITE?o.capturedWhite.push(n.type):o.capturedBlack.push(n.type))}self.postMessage({bestMove:i,captureData:o})};export{w as P,r as a,f as b,g as c};
//# sourceMappingURL=ai.worker-gSuPthGP.js.map
