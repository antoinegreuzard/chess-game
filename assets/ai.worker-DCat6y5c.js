async function E(l,e){switch(l){case h.PAWN:const{Pawn:t}=await Promise.resolve().then(function(){return N});return new t(e);case h.ROOK:const{Rook:i}=await Promise.resolve().then(function(){return W});return new i(e);case h.KNIGHT:const{Knight:s}=await Promise.resolve().then(function(){return A});return new s(e);case h.BISHOP:const{Bishop:n}=await Promise.resolve().then(function(){return B});return new n(e);case h.QUEEN:const{Queen:r}=await Promise.resolve().then(function(){return x});return new r(e);case h.KING:const{King:c}=await Promise.resolve().then(function(){return H});return new c(e);default:throw new Error(`Type de pièce inconnu : ${l}`)}}var u=(l=>(l.WHITE="white",l.BLACK="black",l))(u||{}),h=(l=>(l.PAWN="pawn",l.ROOK="rook",l.KNIGHT="knight",l.BISHOP="bishop",l.QUEEN="queen",l.KING="king",l))(h||{});class M{constructor(e,t){this.color=e,this.type=t}isPathClear(e,t,i,s,n){const r=Math.sign(i-e),c=Math.sign(s-t);let o=e+r,a=t+c;for(;o!==i||a!==s;){if(n.getPiece(o,a)!==null)return!1;o+=r,a+=c}return!0}canCapture(e,t,i){const s=i.getPiece(e,t);return!s||s.color!==this.color}toData(){return{color:this.color,type:this.type}}static async fromData(e){return await E(e.type,e.color)}}class g extends M{hasMoved=!1;constructor(e){super(e,h.ROOK)}isValidMove(e,t,i,s,n){return!(e===i||t===s)||!this.isPathClear(e,t,i,s,n)?!1:this.canCapture(i,s,n)}toData(){return{...super.toData(),hasMoved:this.hasMoved}}static async fromData(e){const t=new g(e.color);return t.hasMoved=e.hasMoved,t}}var W=Object.freeze({__proto__:null,Rook:g});class m extends M{constructor(e){super(e,h.KNIGHT)}isValidMove(e,t,i,s,n){const r=Math.abs(i-e),c=Math.abs(s-t);return(r===2&&c===1||r===1&&c===2)&&this.canCapture(i,s,n)}}var A=Object.freeze({__proto__:null,Knight:m});class y extends M{constructor(e){super(e,h.BISHOP)}isValidMove(e,t,i,s,n){return Math.abs(i-e)===Math.abs(s-t)&&this.isPathClear(e,t,i,s,n)?this.canCapture(i,s,n):!1}}var B=Object.freeze({__proto__:null,Bishop:y});class I extends M{constructor(e){super(e,h.QUEEN)}isValidMove(e,t,i,s,n){return(e===i||t===s||Math.abs(i-e)===Math.abs(s-t))&&this.isPathClear(e,t,i,s,n)?this.canCapture(i,s,n):!1}}var x=Object.freeze({__proto__:null,Queen:I});class d extends M{hasMoved=!1;constructor(e){super(e,h.KING)}isValidMove(e,t,i,s,n){const r=Math.abs(i-e),c=Math.abs(s-t);if(r<=1&&c<=1)return this.canCapture(i,s,n)&&!n.isAdjacentToAnotherKing(i,s,this.color);if(!this.hasMoved&&c===0&&r===2){const o=i>e?1:-1,a=i>e?7:0,f=n.getPiece(a,t);if(f&&f instanceof g&&!f.hasMoved){for(let P=e+o;P!==i;P+=o)if(n.getPiece(P,t)||n.isSquareUnderAttack(P,t,this.color))return!1;return!n.isSquareUnderAttack(i,t,this.color)&&!n.isAdjacentToAnotherKing(i,s,this.color)}}return!1}}var H=Object.freeze({__proto__:null,King:d});class v extends M{hasMoved=!1;constructor(e){super(e,h.PAWN)}isValidMove(e,t,i,s,n){const r=this.color===u.WHITE?1:-1,c=this.color===u.WHITE?1:6,o=(s-t)*r,a=Math.abs(i-e);if(a===0&&o===1&&!n.getPiece(i,s))return(this.color===u.WHITE&&s===7||this.color===u.BLACK&&s===0)&&n.getPiece(i,s)?.type===h.PAWN&&this.handlePromotion(i,s,n),!0;if(a===0&&o===2&&t===c&&!n.getPiece(i,s)&&!n.getPiece(e,t+r))return n.updateEnPassantTarget(e,t,i,s,this),!0;if(a===1&&o===1){if(n.getPiece(i,s)&&this.canCapture(i,s,n))return(this.color===u.WHITE&&s===7||this.color===u.BLACK&&s===0&&n.getPiece(i,s)?.type===h.PAWN)&&this.handlePromotion(i,s,n),!0;if(n.isEnPassantMove(e,t,i,s))return!0}return!1}handlePromotion(e,t,i){const s=document.getElementById("promotionDialog");s&&(s.style.display="block",window.promote=n=>{s.style.display="none",i.promotePawn(e,t,n)})}}var N=Object.freeze({__proto__:null,Pawn:v});let k=[],C=[];function S(l,e){switch(l){case h.PAWN:return e===u.WHITE?"♙":"♟";case h.ROOK:return e===u.WHITE?"♖":"♜";case h.KNIGHT:return e===u.WHITE?"♘":"♞";case h.BISHOP:return e===u.WHITE?"♗":"♝";case h.QUEEN:return e===u.WHITE?"♕":"♛";case h.KING:return e===u.WHITE?"♔":"♚";default:return""}}function O(l,e){const t=S(l,e);e===u.WHITE?k.push(t):C.push(t),_()}function _(){const l=document.getElementById("capturedWhite"),e=document.getElementById("capturedBlack");l&&(l.textContent=k.join(" ")),e&&(e.textContent=C.join(" "))}class T{grid;enPassantTarget=null;halfMoveCount=0;constructor(){this.grid=this.initializeBoard()}initializeBoard(){const e=Array(8).fill(null).map(()=>Array(8).fill(null));return e[0]=[new g(u.WHITE),new m(u.WHITE),new y(u.WHITE),new I(u.WHITE),new d(u.WHITE),new y(u.WHITE),new m(u.WHITE),new g(u.WHITE)],e[1]=Array(8).fill(null).map(()=>new v(u.WHITE)),e[7]=[new g(u.BLACK),new m(u.BLACK),new y(u.BLACK),new I(u.BLACK),new d(u.BLACK),new y(u.BLACK),new m(u.BLACK),new g(u.BLACK)],e[6]=Array(8).fill(null).map(()=>new v(u.BLACK)),e}isWithinBounds(e,t){return e>=0&&e<8&&t>=0&&t<8}getPiece(e,t){return this.grid[t][e]}getValidMoves(e,t){let i=null;if(this.isWithinBounds(e,t)&&(i=this.getPiece(e,t)),!i)return[];const s=[];for(let n=0;n<8;n++)for(let r=0;r<8;r++)i.isValidMove(e,t,r,n,this)&&s.push({x:r,y:n});return s}getKingInCheck(){return this.isKingInCheck(u.WHITE)?this.findKing(u.WHITE):this.isKingInCheck(u.BLACK)?this.findKing(u.BLACK):null}movePiece(e,t,i,s){if(!this.isWithinBounds(e,t)||!this.isWithinBounds(i,s)||["__proto__","constructor","prototype"].includes(t.toString())||["__proto__","constructor","prototype"].includes(s.toString()))return!1;const n=this.getPiece(e,t);if(n&&n.isValidMove(e,t,i,s,this)){const r=this.getPiece(i,s);if(r&&r.type===h.KING)return!1;if(n instanceof d&&Math.abs(i-e)===2)return this.isCastlingValid(n,e,t,i)?(this.handleCastling(i,t),!0):!1;if(n instanceof v&&this.isEnPassantMove(e,t,i,s)&&this.captureEnPassant(e,t,i,s),this.grid[s][i]=n,this.grid[t][e]=null,this.isKingInCheck(n.color))return this.grid[t][e]=n,this.grid[s][i]=r,!1;"hasMoved"in n&&(n.hasMoved=!0),this.updateEnPassantTarget(e,t,i,s,n),this.halfMoveCount=n.type===h.PAWN||r?0:this.halfMoveCount+1;const c=n.color===u.WHITE?u.BLACK:u.WHITE;return this.isCheckmate(c),!0}return!1}isCastlingValid(e,t,i,s){const n=s>t?1:-1,r=s>t?7:0,c=this.getPiece(r,i);if(!(c instanceof g)||c.hasMoved||e.hasMoved)return!1;for(let o=t+n;o!==s;o+=n)if(this.getPiece(o,i)||this.isSquareUnderAttack(o,i,e.color))return!1;return!this.isSquareUnderAttack(t,i,e.color)&&!this.isSquareUnderAttack(s,i,e.color)}handleCastling(e,t){e===6?this.getPiece(7,t)instanceof g&&this.movePiece(7,t,5,t):e===2&&this.getPiece(0,t)instanceof g&&this.movePiece(0,t,3,t)}updateEnPassantTarget(e,t,i,s,n){n instanceof v&&Math.abs(s-t)===2&&e===i?this.enPassantTarget={x:i,y:(t+s)/2}:this.enPassantTarget=null}captureEnPassant(e,t,i,s){const n=this.getPiece(e,t);if(this.isEnPassantMove(e,t,i,s)&&n instanceof v){const r=n.color===u.WHITE?-1:1,c=s+r,o=this.getPiece(i,c);if(o&&o.type===h.PAWN){this.grid[c][i]=null;const a={capturedWhite:[],capturedBlack:[]};return o.color===u.WHITE?a.capturedWhite.push(o.type):a.capturedBlack.push(o.type),O(o.type,o.color),a}}return null}isEnPassantMove(e,t,i,s){return this.enPassantTarget?this.getPiece(e,t)instanceof v&&i===this.enPassantTarget.x&&s===this.enPassantTarget.y&&Math.abs(e-i)===1&&Math.abs(t-s)===1:!1}promotePawn(e,t,i){const s=this.getPiece(e,t)?.color;if(s)switch(i){case"queen":this.grid[t][e]=new I(s);break;case"rook":this.grid[t][e]=new g(s);break;case"bishop":this.grid[t][e]=new y(s);break;case"knight":this.grid[t][e]=new m(s);break}}isKingInCheck(e){const t=this.findKing(e);if(!t)return!1;for(let i=0;i<8;i++)for(let s=0;s<8;s++){const n=this.getPiece(s,i);if(n&&n.color!==e&&n.isValidMove(s,i,t.x,t.y,this))return!0}return!1}isCheckmate(e){if(!this.isKingInCheck(e))return!1;for(let t=0;t<8;t++)for(let i=0;i<8;i++){const s=this.getPiece(i,t);if(s&&s.color===e){const n=this.getValidMoves(i,t);for(const r of n){const c=this.getPiece(r.x,r.y);this.grid[r.y][r.x]=s,this.grid[t][i]=null;const o=!this.isKingInCheck(e);if(this.grid[t][i]=s,this.grid[r.y][r.x]=c,o)return!1}}}return!0}isStalemate(e){if(this.isKingInCheck(e))return!1;for(let t=0;t<8;t++)for(let i=0;i<8;i++){const s=this.getPiece(i,t);if(s&&s.color===e){for(let n=0;n<8;n++)for(let r=0;r<8;r++)if(s.isValidMove(i,t,r,n,this)){const c=this.getPiece(r,n);this.grid[n][r]=s,this.grid[t][i]=null;const o=!this.isKingInCheck(e);if(this.grid[t][i]=s,this.grid[n][r]=c,o)return!1}}}return!0}findKing(e){for(let t=0;t<8;t++)for(let i=0;i<8;i++){const s=this.getPiece(i,t);if(s&&s instanceof d&&s.color===e)return{x:i,y:t}}return null}isKing(e,t){return this.getPiece(e,t)instanceof d}isSquareUnderAttack(e,t,i){for(let s=0;s<8;s++)for(let n=0;n<8;n++){const r=this.getPiece(n,s);if(r&&r.color!==i&&r.isValidMove(n,s,e,t,this))return!0}return!1}isInsufficientMaterial(){const e=this.grid.flat().filter(t=>t!==null);return e.length<=2?!0:e.length===3&&e.some(t=>t?.type===h.BISHOP||t?.type===h.KNIGHT)}isFiftyMoveRule(){return this.halfMoveCount>=50}setPiece(e,t,i){this.grid[t][e]=i}isMoveValid(e,t,i,s){const n=this.getPiece(e,t);if(!n||i<0||i>=8||s<0||s>=8||!n.isValidMove(e,t,i,s,this))return!1;const r=this.getPiece(i,s);return!(r&&r.color===n.color)}isCapture(e,t,i,s){const n=this.isWithinBounds(e,t)?this.getPiece(e,t):null,r=this.isWithinBounds(i,s)?this.getPiece(i,s):null;return n!==null&&r!==null&&n.color!==r.color}static async fromData(e){const t=new T;return t.grid=await Promise.all(e.grid.map(async i=>Promise.all(i.map(async s=>s?await M.fromData(s):null)))),t}toData(){return{grid:this.grid.map(e=>e.map(t=>t?t.toData():null))}}isAdjacentToAnotherKing(e,t,i){const s=[{dx:-1,dy:-1},{dx:-1,dy:0},{dx:-1,dy:1},{dx:0,dy:-1},{dx:0,dy:1},{dx:1,dy:-1},{dx:1,dy:0},{dx:1,dy:1}];for(const{dx:n,dy:r}of s){const c=e+n,o=t+r,a=this.isWithinBounds(c,o)?this.getPiece(c,o):null;if(a instanceof d&&a.color!==i)return!0}return!1}}const V={[h.PAWN]:1,[h.KNIGHT]:3,[h.BISHOP]:3.25,[h.ROOK]:5,[h.QUEEN]:9,[h.KING]:0},D={[h.PAWN]:[[0,0,0,0,0,0,0,0],[.5,.5,.5,.5,.5,.5,.5,.5],[.1,.1,.2,.3,.3,.2,.1,.1],[.05,.05,.1,.25,.25,.1,.05,.05],[0,0,0,.2,.2,0,0,0],[.05,-.05,-.1,0,0,-.1,-.05,.05],[.05,.1,.1,-.2,-.2,.1,.1,.05],[0,0,0,0,0,0,0,0]],[h.KNIGHT]:[[-.5,-.4,-.3,-.3,-.3,-.3,-.4,-.5],[-.4,-.2,0,0,0,0,-.2,-.4],[-.3,0,.1,.15,.15,.1,0,-.3],[-.3,.05,.15,.2,.2,.15,.05,-.3],[-.3,0,.15,.2,.2,.15,0,-.3],[-.3,.05,.1,.15,.15,.1,.05,-.3],[-.4,-.2,0,.05,.05,0,-.2,-.4],[-.5,-.4,-.3,-.3,-.3,-.3,-.4,-.5]],[h.BISHOP]:[[-.2,-.1,-.1,-.1,-.1,-.1,-.1,-.2],[-.1,0,0,0,0,0,0,-.1],[-.1,0,.05,.1,.1,.05,0,-.1],[-.1,.05,.05,.1,.1,.05,.05,-.1],[-.1,0,.1,.1,.1,.1,0,-.1],[-.1,.1,.1,.1,.1,.1,.1,-.1],[-.1,.05,0,0,0,0,.05,-.1],[-.2,-.1,-.1,-.1,-.1,-.1,-.1,-.2]],[h.ROOK]:[[0,0,0,0,0,0,0,0],[.05,.1,.1,.1,.1,.1,.1,.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[-.05,0,0,0,0,0,0,-.05],[0,0,0,.05,.05,0,0,0]],[h.QUEEN]:[[-.2,-.1,-.1,-.05,-.05,-.1,-.1,-.2],[-.1,0,0,0,0,0,0,-.1],[-.1,0,.05,.05,.05,.05,0,-.1],[-.05,0,.05,.05,.05,.05,0,-.05],[0,0,.05,.05,.05,.05,0,-.05],[-.1,.05,.05,.05,.05,.05,0,-.1],[-.1,0,.05,0,0,0,0,-.1],[-.2,-.1,-.1,-.05,-.05,-.1,-.1,-.2]],[h.KING]:[[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.3,-.4,-.4,-.5,-.5,-.4,-.4,-.3],[-.2,-.3,-.3,-.4,-.4,-.3,-.3,-.2],[-.1,-.2,-.2,-.2,-.2,-.2,-.2,-.1],[.2,.2,0,0,0,0,.2,.2],[.2,.3,0,0,0,0,.3,.2]]},K={"3,3":.5,"3,4":.5,"4,3":.5,"4,4":.5,"2,3":.25,"2,4":.25,"3,2":.25,"4,2":.25,"4,5":.25,"3,5":.25,"5,3":.25,"5,4":.25};function w(l,e){let t=0;for(let i=0;i<8;i++)for(let s=0;s<8;s++){const n=l.getPiece(s,i);if(n){let r=V[n.type];const c=D[n.type];c&&(r+=c[i][s]);const o=`${s},${i}`;K[o]&&(r+=K[o]),n.type===h.PAWN&&(r+=L(l,s,i,n.color)),n.type===h.BISHOP&&j(l,n.color)&&(r+=.5),U(l,s,i,n.color)&&(r-=.5),t+=n.color===e?r:-r}}return t}function L(l,e,t,i){let s=0;return s-=G(l,e,t,i)*1.5,s-=q(l,e,t,i)*1.5,s}function G(l,e,t,i){for(let s=0;s<8;s++)if(s!==t&&l.getPiece(e,s)?.type===h.PAWN&&l.getPiece(e,s)?.color===i)return .5;return 0}function q(l,e,t,i){const s=e-1>=0?l.getPiece(e-1,t):null,n=e+1<8?l.getPiece(e+1,t):null;return(!s||s.type!==h.PAWN||s.color!==i)&&(!n||n.type!==h.PAWN||n.color!==i)?1.5:0}function j(l,e){return Q(l,e).filter(i=>i.type===h.BISHOP).length===2}function U(l,e,t,i){const s=l.getPiece(e,t);return s&&s.type===h.KING?[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}].some(({dx:r,dy:c})=>{const o=e+r,a=t+c;if(l.isWithinBounds(o,a)){const f=l.getPiece(o,a);return!f||f.color!==i||f.type===h.KING}return!0}):!1}function Q(l,e){const t=[];for(let i=0;i<8;i++)for(let s=0;s<8;s++){const n=l.getPiece(s,i);n&&n.color===e&&t.push(n)}return t}class z{constructor(e,t=5e3){this.color=e,this.transpositionTable=new Map,this.maxTime=t,this.killerMoves={},this.startTime=0}transpositionTable;maxTime;startTime;killerMoves;makeMove(e){let t=null,i=-1/0;const s=7;this.startTime=Date.now();for(let n=1;n<=s;n++){let r=this.getAllValidMoves(e);r=this.sortMoves(r,e,n);for(const c of r){const o=e.getPiece(c.fromX,c.fromY),a=e.getPiece(c.toX,c.toY);e.movePiece(c.fromX,c.fromY,c.toX,c.toY);const f=this.minimax(e,n-1,-1/0,1/0,!1);if(e.setPiece(c.fromX,c.fromY,o),e.setPiece(c.toX,c.toY,a),f>i&&(i=f,t=c),Date.now()-this.startTime>this.maxTime)break}if(Date.now()-this.startTime>this.maxTime)break}return t}minimax(e,t,i,s,n){const r=e.toString();if(Date.now()-this.startTime>this.maxTime)return w(e,this.color);if(this.transpositionTable.has(r))return this.transpositionTable.get(r);if(t===0||e.isCheckmate(this.color)||e.isCheckmate(this.getOpponentColor())||Date.now()-this.startTime>this.maxTime){const c=this.quiescenceSearch(e,i,s);return this.transpositionTable.set(r,c),c}if(e.isKingInCheck(this.color)&&this.getAllValidMoves(e).length===0)return-1/0;if(n){let c=-1/0,o=this.getAllValidMoves(e);o=this.sortMoves(o,e,t);for(const a of o){const f=e.getPiece(a.fromX,a.fromY),P=e.getPiece(a.toX,a.toY);e.movePiece(a.fromX,a.fromY,a.toX,a.toY);const p=this.minimax(e,t-1,i,s,!1);if(e.setPiece(a.fromX,a.fromY,f),e.setPiece(a.toX,a.toY,P),c=Math.max(c,p),i=Math.max(i,p),s<=i){this.addKillerMove(t,a);break}}return this.transpositionTable.set(r,c),c}else{let c=1/0,o=this.getAllValidMoves(e);o=this.sortMoves(o,e,t);for(const a of o){const f=e.getPiece(a.fromX,a.fromY),P=e.getPiece(a.toX,a.toY);e.movePiece(a.fromX,a.fromY,a.toX,a.toY);const p=this.minimax(e,t-1,i,s,!0);if(e.setPiece(a.fromX,a.fromY,f),e.setPiece(a.toX,a.toY,P),c=Math.min(c,p),s=Math.min(s,p),s<=i){this.addKillerMove(t,a);break}}return this.transpositionTable.set(r,c),c}}addKillerMove(e,t){this.killerMoves[e]||(this.killerMoves[e]=[]),this.killerMoves[e].push(t)}quiescenceSearch(e,t,i,s=0){if(s>=10)return w(e,this.color);const r=w(e,this.color);if(r>=i)return i;t<r&&(t=r);const c=this.getAllValidMoves(e).filter(o=>e.isCapture(o.fromX,o.fromY,o.toX,o.toY));for(const o of c){const a=e.getPiece(o.fromX,o.fromY),f=e.getPiece(o.toX,o.toY);if(e.movePiece(o.fromX,o.fromY,o.toX,o.toY),!e.isKingInCheck(this.color)){const p=-this.quiescenceSearch(e,-i,-t,s+1);if(e.setPiece(o.fromX,o.fromY,a),e.setPiece(o.toX,o.toY,f),p>=i)return i;p>t&&(t=p)}else e.setPiece(o.fromX,o.fromY,a),e.setPiece(o.toX,o.toY,f)}return t}getOpponentColor(){return this.color===u.WHITE?u.BLACK:u.WHITE}getAllValidMoves(e){const t=[];for(let i=0;i<8;i++)for(let s=0;s<8;s++){const n=e.getPiece(s,i);if(n&&n.color===this.color){const r=e.getValidMoves(s,i);for(const c of r)if(e.isMoveValid(s,i,c.x,c.y)){const o=e.getPiece(c.x,c.y);e.setPiece(c.x,c.y,n),e.setPiece(s,i,null);const a=!e.isKingInCheck(this.color);e.setPiece(s,i,n),e.setPiece(c.x,c.y,o),a&&t.push({fromX:s,fromY:i,toX:c.x,toY:c.y})}}}return t}sortMoves(e,t,i){return e.sort((s,n)=>{if(this.killerMoves[i]&&this.killerMoves[i].some(f=>f.fromX===s.fromX&&f.fromY===s.fromY))return-1;const r=t.getPiece(s.toX,s.toY),c=t.getPiece(n.toX,n.toY);if(r&&!c)return-1;if(!r&&c)return 1;const o=K[`${s.toX},${s.toY}`]||0;return(K[`${n.toX},${n.toY}`]||0)-o})}}const $=new z(u.BLACK);self.onmessage=async l=>{const{boardData:e}=l.data,t=await T.fromData(e),i=$.makeMove(t);let s=null;if(i&&t.isCapture(i.fromX,i.fromY,i.toX,i.toY)){const n=t.getPiece(i.toX,i.toY);n&&(s={capturedWhite:[],capturedBlack:[]},n.color===u.WHITE?s.capturedWhite.push(n.type):s.capturedBlack.push(n.type))}self.postMessage({bestMove:i,captureData:s})};
//# sourceMappingURL=ai.worker-DCat6y5c.js.map
